<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>
			Specification of the Mobile Authenticator for the Battle.net&reg;
		</title>
		<style type="text/css">
			li { padding-bottom: 0.5em; }
		</style>
	</head>
	<body>
		<h1>Specification of the Mobile Authenticator for the Battle.net&reg;</h1>
		<h2>Table of Contents</h2>
		<ul>
			<li>
			<h3>Server Communication</h3>
			<ul>
				<li>
				<h4>Authenticator Initialization</h4>
				<ul>
					<li>
					<a href="#initrequest">Request</a>
					</li>
					<li>
					<a href="#initresponse">Response</a>
					</li>
				</ul>
				</li>
				<li>
				<h4>Authenticator Time Synchronization</h4>
				<ul>
					<li>
					<a href="#syncrequest">Request</a>
					</li>
					<li>
					<a href="#syncresponse">Response</a>
					</li>
				</ul>
				</li>
			</ul>
			</li>
			<li>
			<h3>
				<a href="#codecalc">Code Calculation</a>
			</h3>
			</li>
		</ul>
		<h2>
			<a name="initrequest">Authenticator Initialization Request</a>
		</h2>
		<p>
		Initialization request is an HTTP POST request to
		</p>
		<ul>
			<li>
			<b>http://m.eu.mobileservice.blizzard.com/enrollment/enroll.htm</b> (Europe)
			</li>
			<li>
			<b>http://m.us.mobileservice.blizzard.com/enrollment/enroll.htm</b> (North America)
			</li>
		</ul>
		<p>
		with Content-type &quot;application/octet-stream&quot;. The plaintext of the
		request has the following format:		
		</p>
		<table border="1">
			<tr style="background-color:#FF8080">
				<td style="width:10%">function code</td>
				<td style="width:50%">response encryption key</td>
				<td style="width:15%">region code</td>
				<td style="width:25%">mobile model</td>
			</tr>
			<tr>
				<td>1 byte</td>
				<td>37 bytes</td>
				<td>2 bytes</td>
				<td>16 bytes</td>
			</tr>
		</table>
		<ul>
			<li>
			<b>Function code:</b> always &quot;1&quot;
			</li>
			<li>
			<b>Response encryption key:</b> Random bytes for one time pad encryption of the
			response. Blizzard is using the default Java random number generator (initialized
			with the current system time), hashes the created random bytes via SHA1 and is
			using the hash output for the key. But every other good source of randomness
			would be also OK here.
			</li>
			<li>
			<b>Region code:</b> &quot;EU&quot; or &quot;US&quot; but doesn't have any meaning -
			distinction is only done via the URL and not via the code here.
			</li>
			<li>
			<b>Mobile model:</b> Default value is &quot;Motorola RAZR v3&quot; but every
			other 16 bytes would be also OK. Seems to be only a statistical record.
			</li>
		</ul>
		<p>
		The plaintext is then encrypted with RSA-1024 (upper bytes of the RSA-block are
		padded with zeros). The modulus is
		</p>
<pre>
	0x955e4bd989f3917d2f15544a7e0504eb9d7bb66b6f8a2fe470e453c779200e5e
	3ad2e43a02d06c4adbd8d328f1a426b83658e88bfd949b2af4eaf30054673a14
	19a250fa4cc1278d12855b5b25818d162c6e6ee2ab4a350d401d78f6ddb99711
	e72626b48bd8b5b0b7f3acf9ea3c9e0005fee59e19136cdb7c83f2ab8b0a2a99
</pre>
		<p>
		(big endian) and the public exponent is &quot;0x101&quot; (257). The resulting
		128 encrypted bytes are sent to the server within the HTTP-POST-request. Europe
		and North America are using the same keys for RSA.
		</p>
		<h2>
			<a name="initresponse">Authenticator Initialization Response</a>
		</h2>
		<p>
		The HTTP body of the response has the following format:
		</p>
		<table border="1">
			<tr style="background-color:#FF8080">
				<td style="width:40%">current server time</td>
				<td style="width:60%">encrypted initialization data</td>
			</tr>
			<tr>
				<td>8 bytes</td>
				<td>37 bytes</td>
			</tr>
		</table>
		<ul>
			<li>
			<b>Current server time:</b> Milliseconds since midnight, January 1, 1970 UTC
			(like returnded by System.currentTimeMillis() in Java), big endian format.
			</li>
			<li>
			<b>Encrypted initialization data:</b> One time pad encrypted data with initialization
			information for the authenticator. The decryption key is the key sent to the
			server within the initialization request.
			</li>
		</ul>
		<p>
		After decryption the initialization information has the following format:
		</p>
		<table border="1">
			<tr style="background-color:#FF8080">
				<td style="width:60%">secret key for code calculation</td>
				<td style="width:40%">authenticator serial number</td>
			</tr>
			<tr>
				<td>20 bytes</td>
				<td>17 bytes</td>
			</tr>
		</table>
		<ul>
			<li>
			<b>Secret key for code calculation:</b> Secret key generated by the server for
			calculation of the authenticator codes. Refer to <a href="#codecalc">code
				calculation section</a> for the usage of this key. The key <i>MUST</i> be
			stored within the authenticator as long as it is linked to a Battle.net&reg; account
			and <i>MUST</i> kept secret.
			</li>
			<li>
			<b>Authenticator serial number:</b> Serial number of the authenticator used for
			linking it to a Battle.net&reg; account. It has the format &quot;EU-1234-5678-9012&quot;
			or &quot;US-1234-5678-9012&quot;. The number seems to be simply incremented by
			the server for every initialization request. There should be no way to calculate
			the secret key corresponding to this serial number. The serial number <i>SHOULD</i>
			be stored together with the secret key, thus the authenticator can later be linked
			also to other Battle.net&reg; accounts.
			</li>
		</ul>
		<h2>
			<a name="syncrequest">Authenticator Time Synchronization Request</a>
		</h2>
		<p>
		Synchronization request is simply an HTTP GET request to
		</p>
		<ul>
			<li>
			<b>http://m.eu.mobileservice.blizzard.com/enrollment/time.htm</b> (Europe)
			</li>
			<li>
			<b>http://m.us.mobileservice.blizzard.com/enrollment/time.htm</b> (North America)
			</li>
		</ul>
		<h2>
			<a name="syncresponse">Authenticator Time Synchronization Response</a>
		</h2>
		<p>
		The HTTP body of the response has the following format:
		</p>
		<table border="1">
			<tr style="background-color:#FF8080">
				<td>current server time</td>
			</tr>
			<tr>
				<td>8 bytes</td>
			</tr>
		</table>
		<ul>
			<li>
			<b>Current server time:</b> Milliseconds since midnight, January 1, 1970 UTC
			(like returnded by System.currentTimeMillis() in Java), big endian format.
			</li>
		</ul>
		<h2>
			<a name="codecalc">Authenticator Code Calculation</a>
		</h2>
		<p>
		Starting point of the calculation are the secret key (returned by the server
		within the authenticator initialization response) and the current code interval 
		number. Code interval length is 30 seconds (every 30 seconds a new code is
		generated). To calculate the current code interval number the current server time
		in milliseconds (as returned from the time synchronization request) has to be known
		and is simply divided by 30,000 (midnight, January 1, 1970 UTC started with code
		interval 0 and every 30 seconds the code interval counter is incremented by 1).
		</p>
		<p>
		If there is a local clock with enough accuracy available, it is not necessary
		to request the server time for every code calculation. It is enough to store
		the time difference between server and local clock when doing the initialization
		of the authenticator and calculate the current server time from the local time
		and the stored time difference. Only if the divergence between server and local
		clock has significantly changed, a new synchronization has to be done.
		</p>
		<p>
		The code interval number is stored in 8 bytes (big endian order) and is used as
		message for HMAC-SHA1 (the key is the secret key from the initialization response).
		The result is a 20 bytes MAC of the code interval number. From this 20 bytes MAC
		4 bytes are selected as the current code. The last 4 bit of the MAC determine
		the starting byte of the 4 selected bytes.
		</p>
		<p>
		Finally the last 8 digits (radix 10) of the 4 selected bytes (big endian order) are
		displayed by the authenticator as the current code.
		</p>
		<p>Short form:</p>
		<pre>
	// calculate current interval number
	long intervalNumber = (CLIENT_TIME_IN_MILLISECONDS + TIME_DIFFERENCE_TO_SERVER) / 30000
	// calculate HMAC-SHA1 from secret key and interval number
	byte[20] mac = HMAC-SHA1(SECRET_KEY, intervalNumber)
	// determine which 4 bytes of the MAC are taken as the current code
	// last 4 bit of the MAC points to the starting byte
	int startPos = mac[19] &amp; 0x0F
	// select the byte at starting position and the following 3 bytes
	int selectedInt = mac[startPos .. startPos + 3]
	// use the lowest 8 decimal digits from the selected integer as the
	// current authenticator code
	return selectedInt % 100000000
		</pre>
		</body>
	</html>
